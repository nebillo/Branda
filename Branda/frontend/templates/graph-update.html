{% extends "base.html" %}

{% block head %}
  <script src="/js/json.js"></script>
  <script src="/js/util.js"></script>
{% end %}


{% block body %}

  <p id="wait">updating your things...</p>
  
  <div id="fb-root"></div>
  <script>
    
    var pending_requests = 4;
    var post_data = "_xsrf=" + getCookie("_xsrf");
    
    function saveResponse(key, value) {
      var jsonString = value.toJSONString();
      jsonString = encodeURIComponent(jsonString);
      post_data += "&" + encodeURIComponent(key) + "=" + jsonString;
      
      pending_requests --;
      if (pending_requests <= 0) {
        // post data
        downloadUrl("/graph/data", "POST", post_data, function(response) {
          // data posted
          window.location.reload()
        });
      }
    }
    
    function updateThings() {
      var updated_at = {{ current_user.updatedAtInUnixFormat() }};
      
      <!-- upadate info -->
      FB.api('/me', function(response) {
        saveResponse("info", response);
      });

      <!-- upadate likes -->
      FB.api('/me/likes', { 'since': updated_at, 'fields': 'name,picture,category' }, function(response) {
        saveResponse("likes", response.data);
      });

      <!-- upadate events -->
      FB.api('/me/events', { 'since': updated_at, 'fields': 'name,start_time,end_time,location,venue,privacy,picture' }, function(response) {
        saveResponse("events", response.data);
      });

      <!-- upadate places -->
      FB.api('/me/checkins', { 'since': updated_at }, function(response) {
        saveResponse("places", response.data);
      });
    }
    
    window.fbAsyncInit = function() {
      FB.init({appId: '{{ options.facebook_app_id }}', status: true, cookie: true, xfbml: true});
      FB.getLoginStatus(function(response) {
        if (response.session && response.perms) {
          // user authentication is valid
          updateThings();
        } else {
          // user is not authenticated anymore
          window.location = "/logout";
        }
      }, true);
    };
    
    (function() {
      var e = document.createElement('script');
      e.type = 'text/javascript';
      e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
      e.async = true;
      document.getElementById('fb-root').appendChild(e);
    }());
      
  </script>
  
{% end %}